env:
  # Fail fast if any command in a pipeline fails
  SHELLOPTS: errexit pipefail

steps:
  # ----------------------------------------
  # Lint
  # ----------------------------------------
  - label: ":rubocop: RuboCop"
    key: rubocop
    plugins:
      - docker#v5.11.0:
          image: "ruby:3.4" # Use a recent stable Ruby for linting
          shell: ["/bin/bash", "-e", "-c"]
    commands:
      - bundle config set path 'vendor/bundle'
      - bundle install --jobs=4 --retry=3
      - bundle exec rubocop

  - wait

  # ----------------------------------------
  # RSpec test matrix (parallelized)
  # ----------------------------------------

  - label: ":rspec: Ruby 3.4"
    key: rspec
    parallelism: 4
    plugins:
      - docker#v5.11.0:
          image: "ruby:3.4"
          propagate-environment: true
          environment:
            - BUILDKITE_PARALLEL_JOB
            - BUILDKITE_PARALLEL_JOB_COUNT
          shell: ["/bin/bash", "-e", "-c"]
    command: .buildkite/script/test
    artifact_paths:
      - "coverage/resultset-*.json"

  - label: ":package: Collate coverage reports"
    depends_on: rspec
    key: collate-coverage
    plugins:
      - artifacts#v1.9.4:
          download: "coverage/resultset-*.json"
      - docker#v5.11.0:
          image: "ruby:3.4"
          mount-buildkite-agent: true
          propagate-environment: true
          shell: ["/bin/bash", "-e", "-c"]
    command: .buildkite/script/collate
    artifact_paths:
      - "coverage/index.html"
      - "coverage/assets/**/*"
      - "coverage/coverage.json"

  - label: "Report coverage to GitHub"
    depends_on: collate-coverage
    key: report-coverage
    if: build.pull_request.id != ""
    plugins:
      - artifacts#v1.9.4:
          download: "coverage/coverage.json"
      - docker#v5.11.0:
          image: "ruby:3.4"
          mount-buildkite-agent: true
          propagate-environment: true
          environment:
            - GITHUB_TOKEN
            - REPO
            - PR_NUMBER
            - COMMIT_SHA
            - BUILDKITE_ORGANIZATION_SLUG
            - BUILDKITE_PIPELINE_SLUG
            - BUILDKITE_BUILD_NUMBER
            - ARTIFACT_API_ACCESS_TOKEN
            - COVERAGE_REPORTER_LOG_LEVEL
          shell: ["/bin/bash", "-e", "-c"]
    secrets:
      - GITHUB_TOKEN
      - ARTIFACT_API_ACCESS_TOKEN
    env:
      REPO: ${BUILDKITE_PULL_REQUEST_REPO}
      PR_NUMBER: ${BUILDKITE_PULL_REQUEST}
      COMMIT_SHA: ${BUILDKITE_COMMIT}
      COVERAGE_REPORTER_LOG_LEVEL: DEBUG
    command: .buildkite/script/report
